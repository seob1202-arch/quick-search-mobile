<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Biz Connect | í”„ë¦¬ë¯¸ì—„ ë¹„ì¦ˆë‹ˆìŠ¤ ê²€ìƒ‰</title>
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/variable/pretendardvariable.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- [1] Reset & Variables (Premium Dark Theme) --- */
        :root {
            --bg-color: #0F1014;       /* Ultra Dark Background */
            --surface-color: #1A1C23;  /* Card Background */
            --primary-color: #7C3AED;  /* Vivid Purple */
            --primary-gradient: linear-gradient(135deg, #7C3AED 0%, #4F46E5 100%);
            --text-main: #FFFFFF;
            --text-sub: #94A3B8;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-color: #F59E0B;   /* Gold */
            --radius-md: 16px;
            --radius-lg: 24px;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Pretendard Variable', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #050508;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(circle at 50% 0%, #2e1065 0%, #050508 60%);
        }

        /* --- [2] PC Optimized Layout --- */
        .app-container {
            width: 100%;
            max-width: 1200px; /* PC Wide Layout */
            height: 90vh;      /* Fixed Height Window */
            min-height: 800px;
            background: var(--bg-color);
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* Pages */
        .page {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 40px 60px; /* Wider padding for PC */
            animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .page.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Scrollbar */
        .page::-webkit-scrollbar { width: 8px; }
        .page::-webkit-scrollbar-track { background: var(--bg-color); }
        .page::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .page::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* --- [3] UI Components --- */
        
        /* Headers */
        .header {
            display: flex; align-items: center; gap: 20px;
            margin-bottom: 40px; padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .header-title { font-size: 28px; font-weight: 800; }
        .back-btn {
            width: 48px; height: 48px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-main); font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--primary-color); transform: translateX(-2px); }

        /* Chips & Grids */
        .grid-layout { display: grid; gap: 16px; margin-bottom: 40px; }
        .grid-layout.location { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .grid-layout.category { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }

        .chip {
            background: var(--surface-color);
            border: 1px solid transparent;
            border-radius: 12px; padding: 18px;
            text-align: center; font-size: 15px; color: var(--text-sub); font-weight: 500;
            cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .chip:hover { background: #252836; color: white; transform: translateY(-2px); }
        .chip.selected {
            background: var(--primary-gradient); color: white;
            font-weight: 700; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4); border: none;
        }

        /* Buttons */
        .btn-cta {
            width: 100%; padding: 22px; margin-top: 20px;
            background: var(--primary-gradient);
            color: white; border: none; border-radius: 16px;
            font-size: 18px; font-weight: 700;
            cursor: pointer; box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
            transition: all 0.2s;
        }
        .btn-cta:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(124, 58, 237, 0.5); }
        .btn-cta:active { transform: scale(0.98); }

        /* Result Cards (3-Column Grid for PC) */
        .biz-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 24px; 
        }
        .biz-card {
            background: var(--surface-color);
            padding: 24px; border-radius: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .biz-card:hover { 
            transform: translateY(-8px); 
            border-color: var(--primary-color); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3); 
        }
        .biz-name { font-size: 20px; font-weight: 700; color: white; margin-bottom: 4px; }
        .biz-rating { color: var(--accent-color); font-weight: 600; font-size: 15px; }
        .biz-addr { font-size: 14px; color: var(--text-sub); margin-top: 8px;}
        .tag { font-size: 12px; padding: 6px 10px; background: rgba(255,255,255,0.05); border-radius: 8px; color: #cbd5e1; display: inline-block; margin-top: 12px; margin-right: 4px; }

        /* Detail Page (PC 2-Column Layout) */
        .detail-header-section {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 60px 40px; border-radius: 24px; margin-bottom: 30px;
            text-align: center; border: 1px solid var(--border-color);
        }
        .detail-name { font-size: 36px; font-weight: 800; color: white; margin-bottom: 8px; }
        .detail-rating { font-size: 20px; color: var(--accent-color); font-weight: 600; }

        .detail-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; align-items: start; }
        
        .info-card { 
            background: var(--surface-color); border-radius: 20px; padding: 30px; 
            border: 1px solid var(--border-color); margin-bottom: 0;
        }
        .info-row { display: flex; gap: 16px; margin-bottom: 20px; align-items: center; }
        .info-icon { width: 40px; text-align: center; color: var(--primary-color); font-size: 20px; }
        .info-text { font-size: 16px; color: var(--text-main); flex: 1; }
        .info-text a { color: #A78BFA; text-decoration: none; font-weight: 600; }
        .info-text a:hover { text-decoration: underline; }

        /* Action Buttons (PC Sticky Side) */
        .action-container { 
            position: sticky; top: 0; 
            display: flex; flex-direction: column; gap: 16px; 
        }
        .act-btn { 
            width: 100%; padding: 20px; border-radius: 16px; font-weight: 700; border: none; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px;
            transition: all 0.2s;
        }
        .act-btn.call { background: var(--primary-color); color: white; box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3); }
        .act-btn.call:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(124, 58, 237, 0.5); }
        .act-btn.map { background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--border-color); }
        .act-btn.map:hover { background: rgba(255,255,255,0.1); }

        /* Loading */
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(15, 16, 20, 0.8);
            display: none; align-items: center; justify-content: center; z-index: 100;
            backdrop-filter: blur(8px);
        }
        .loading-overlay.show { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Filter Tabs */
        .filter-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 30px; }
        .filter-btn {
            padding: 10px 20px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color); border-radius: 20px;
            color: var(--text-sub); font-size: 14px; white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .filter-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Location Banner */
        .loc-banner {
            background: rgba(124, 58, 237, 0.1); border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 16px; padding: 20px; margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .loc-banner.hidden { display: none; }
        .loc-btn { background: var(--primary-color); color: white; border: none; padding: 10px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .loc-btn:hover { background: #6D28D9; }

        /* Mobile Responsive Overrides */
        @media (max-width: 768px) {
            .app-container { height: 100vh; border-radius: 0; border: none; }
            .grid-layout.location { grid-template-columns: repeat(3, 1fr); }
            .grid-layout.category { grid-template-columns: 1fr; }
            .biz-list { grid-template-columns: 1fr; }
            .detail-grid { grid-template-columns: 1fr; }
            .detail-header-section { margin: -40px -24px 30px; border-radius: 0 0 24px 24px; padding: 40px 24px; }
            .action-container { position: static; margin-top: 20px; flex-direction: row; }
            .page { padding: 30px 20px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <div class="page" id="mainPage">
        <div style="height:100%; display:flex; flex-direction:column; justify-content:center; text-align:center;">
            <div style="font-size:60px; margin-bottom:20px;">ğŸŒ</div>
            <h1 style="font-size:40px; font-weight:800; margin-bottom:30px;">K-Biz Connect</h1>
            <button class="btn-cta" style="max-width:300px; margin:0 auto;" onclick="goToSearch()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="page active" id="searchPage">
        <div class="header">
            <button class="back-btn" onclick="alert('ì²« í™”ë©´ì…ë‹ˆë‹¤.')"><i class="fas fa-chevron-left"></i></button>
            <div class="header-title">ì¡°ê±´ ê²€ìƒ‰</div>
        </div>

        <div class="loc-banner hidden" id="locationBanner">
            <div style="font-size:15px; color:#ddd; display:flex; align-items:center; gap:10px;">
                <i class="fas fa-map-marker-alt" style="color:var(--primary-color);"></i> 
                ê±°ë¦¬ìˆœ ì •ë ¬ì„ ìœ„í•´ ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
            </div>
            <button class="loc-btn" onclick="requestLocationPermission()">í—ˆìš©</button>
        </div>

        <div class="section-title" style="margin-bottom:20px;">
            <i class="fas fa-map-marked-alt"></i> ì§€ì—­ ì„ íƒ
        </div>
        <div class="grid-layout location" id="locationGrid">
            </div>

        <div class="section-title" style="margin-top:50px; margin-bottom:20px;">
            <i class="fas fa-layer-group"></i> ì¹´í…Œê³ ë¦¬ ì„ íƒ
        </div>
        <div class="grid-layout category" id="categoryGrid">
            </div>

        <button class="btn-cta" onclick="doSearch()">
            ê²€ìƒ‰ ê²°ê³¼ ë³´ê¸°
        </button>
    </div>

    <div class="page" id="resultsPage">
        <div class="header">
            <button class="back-btn" onclick="goToSearch()"><i class="fas fa-arrow-left"></i></button>
            <div style="flex:1; margin-left:20px;">
                <div style="font-size:20px; font-weight:700; color:white;" id="resTitle">ê²€ìƒ‰ ê²°ê³¼</div>
                <div style="font-size:14px; color:var(--text-sub);" id="resSub">ì¡°ê±´ì„ í™•ì¸í•˜ì„¸ìš”</div>
            </div>
        </div>

        <div class="filter-scroll">
            <button class="filter-btn active" data-sort="default">ê¸°ë³¸ìˆœ</button>
            <button class="filter-btn" data-sort="popularity">ğŸ”¥ ì¸ê¸°ìˆœ</button>
            <button class="filter-btn" data-sort="distance">ğŸ“ ê±°ë¦¬ìˆœ</button>
            <button class="filter-btn" data-sort="rating">â­ í‰ì ìˆœ</button>
        </div>

        <div id="businessList" class="biz-list">
            </div>
    </div>

    <div class="page" id="detailPage" style="padding:0;">
        <div class="detail-hero">
            <button class="back-btn" onclick="goToResults()" style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.2);"><i class="fas fa-arrow-left"></i></button>
            <div class="detail-name" id="dtName">ë¹„ì¦ˆë‹ˆìŠ¤ ì´ë¦„</div>
            <div class="detail-score" id="dtRating">â­ 0.0 (0)</div>
        </div>

        <div style="padding: 0 24px 40px;">
            <div class="detail-grid">
                <div>
                    <div class="info-card">
                        <h3 class="section-title" style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:16px; margin-bottom:24px;">
                            <i class="fas fa-info-circle"></i> ê¸°ë³¸ ì •ë³´
                        </h3>
                        <div class="info-row">
                            <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="info-text" id="dtAddr">ì£¼ì†Œ ì •ë³´ ì—†ìŒ</div>
                        </div>
                        <div class="info-row">
                            <div class="info-icon"><i class="fas fa-phone"></i></div>
                            <div class="info-text" id="dtPhone">ì „í™”ë²ˆí˜¸ ì—†ìŒ</div>
                        </div>
                        <div class="info-row">
                            <div class="info-icon"><i class="fas fa-clock"></i></div>
                            <div class="info-text" id="dtHours">ìš´ì˜ì‹œê°„ ì •ë³´ ì—†ìŒ</div>
                        </div>
                        <div class="info-row" id="dtWebRow" style="display:none;">
                            <div class="info-icon"><i class="fas fa-globe"></i></div>
                            <div class="info-text" id="dtWeb"></div>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3 class="section-title" style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:16px; margin-bottom:24px;">
                            <i class="fas fa-comment-dots"></i> ë¦¬ë·°
                        </h3>
                        <div id="reviewsList">
                            <div style="text-align:center; color:var(--text-sub); padding:10px;">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    </div>
                </div>

                <div class="action-container">
                    <div class="info-card" style="margin-bottom:0;">
                        <div style="font-size:16px; font-weight:700; color:white; margin-bottom:20px; text-align:center;">
                            ë°”ë¡œ ì—°ê²°í•˜ê¸°
                        </div>
                        <button class="act-btn call" onclick="makeCall()">
                            <i class="fas fa-phone-alt"></i> ì „í™” ê±¸ê¸°
                        </button>
                        <div style="height:12px;"></div>
                        <button class="act-btn map" onclick="openMap()">
                            <i class="fas fa-map-marked-alt"></i> ê¸¸ì°¾ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // --- 1. Config & Data ---
    // â˜… GAS URLì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš” â˜…
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbya3GL2Kcy4sMO71OXDdAJIipTQ-UmhIkSR7XV_IILrtrjnFFz6Q-uuZlndY8bkpqMb/exec';
    
    const categoryEmojiMap = {
        'í•œì‹ë‹¹/ì¹´í˜': 'ğŸ½ï¸', 'ë§ˆíŠ¸/ì‹í’ˆì ': 'ğŸ›’', 'ë·°í‹° ì„œë¹„ìŠ¤': 'ğŸ’‡',
        'ì˜ë£Œ ì„œë¹„ìŠ¤': 'ğŸ¥', 'ë²•ë¥ /ì„¸ë¬´': 'âš–ï¸', 'ìƒí™œ ì„œë¹„ìŠ¤': 'ğŸ› ',
        'êµìœ¡/í•™ì›': 'ğŸ“š', 'ì´ì‚¬/ìš´ì†¡': 'ğŸ“¦', 'ì¢…êµ': 'â›ª'
    };

    let allData = {}, currentList = [], selLoc = '', selCat = '', currBiz = null, userLoc = null;

    // --- 2. Initialize ---
    document.addEventListener('DOMContentLoaded', () => {
        initApp();
        setupEvents();
        checkPermission();
    });

    async function initApp() {
        showLoading();
        try {
            const res = await fetch(GAS_WEB_APP_URL);
            const data = await res.json();
            if(data.error) throw new Error(data.error);

            allData = data.businessesByCategory;
            renderFilters(data.filters);
        } catch(e) {
            console.error(e);
            // Fallback for Preview
            renderFilters({
                locations: ['ë¯¸êµ­', 'ìºë‚˜ë‹¤', 'í˜¸ì£¼', 'ë² íŠ¸ë‚¨', 'ì¼ë³¸', 'ì˜êµ­'],
                categories: ['í•œì‹ë‹¹/ì¹´í˜', 'ë§ˆíŠ¸/ì‹í’ˆì ', 'ì˜ë£Œ ì„œë¹„ìŠ¤', 'ë·°í‹° ì„œë¹„ìŠ¤']
            });
        } finally {
            hideLoading();
        }
    }

    // --- 3. Rendering ---
    function renderFilters(filters) {
        const locGrid = document.getElementById('locationGrid');
        const catGrid = document.getElementById('categoryGrid');

        if(filters.locations) {
            locGrid.innerHTML = filters.locations.map((loc, i) => {
                if(i===0) selLoc = loc;
                return `<div class="chip location ${i===0?'selected':''}" data-val="${loc}">${loc}</div>`;
            }).join('');
        }

        if(filters.categories) {
            catGrid.innerHTML = filters.categories.map((cat, i) => {
                if(i===0) selCat = cat;
                return `<div class="chip category ${i===0?'selected':''}" data-val="${cat}">
                    ${categoryEmojiMap[cat]||'ğŸ”¹'} ${cat}
                </div>`;
            }).join('');
        }
    }

    function renderList(list) {
        const wrap = document.getElementById('businessList');
        if(!list || list.length === 0) {
            wrap.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:40px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        wrap.innerHTML = list.map(biz => {
            const dist = (biz.distance && biz.distance < 9999) ? `ğŸ“ ${biz.distance.toFixed(1)}km` : `â­ ${biz.rating||0}`;
            return `
            <div class="biz-card" onclick='openDetail(${JSON.stringify(biz)})'>
                <div class="biz-header">
                    <div class="biz-name">${biz.name}</div>
                    <div class="biz-rating">${dist}</div>
                </div>
                <div class="biz-addr">${biz.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
                <div class="tag-row">
                    ${(biz.tags||[]).map(t => `<span class="tag">#${t}</span>`).join('')}
                </div>
            </div>`;
        }).join('');
    }

    // --- 4. Logic ---
    function setupEvents() {
        document.getElementById('locationGrid').addEventListener('click', e => {
            if(e.target.classList.contains('chip')) {
                document.querySelectorAll('.chip.location').forEach(c => c.classList.remove('selected'));
                e.target.classList.add('selected');
                selLoc = e.target.dataset.val;
            }
        });

        document.getElementById('categoryGrid').addEventListener('click', e => {
            if(e.target.classList.contains('chip')) {
                document.querySelectorAll('.chip.category').forEach(c => c.classList.remove('selected'));
                e.target.classList.add('selected');
                selCat = e.target.dataset.val;
            }
        });

        document.querySelector('.filter-scroll').addEventListener('click', e => {
            if(e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                sortList(e.target.dataset.sort);
            }
        });
    }

    function doSearch() {
        if(!selCat || !selLoc) return alert('ì¡°ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        
        showLoading();
        const data = allData[selCat] || [];
        
        // Data Fallback for Preview if API empty
        currentList = data.length ? data.filter(b => b.location && b.location.includes(selLoc)) : [
            {name:'ìƒ˜í”Œ ë¹„ì¦ˆë‹ˆìŠ¤ A', location:selLoc, address:'ì‹œë‚´ ì¤‘ì‹¬ê°€ 123', rating:4.8, reviews:10},
            {name:'ìƒ˜í”Œ ë¹„ì¦ˆë‹ˆìŠ¤ B', location:selLoc, address:'í•œì¸íƒ€ìš´ 456', rating:4.2, reviews:5}
        ];

        document.getElementById('resTitle').innerText = selCat;
        document.getElementById('resSub').innerText = `${selLoc} ê²€ìƒ‰ ê²°ê³¼ ${currentList.length}ê±´`;
        
        // Reset sort
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('.filter-btn[data-sort="default"]').classList.add('active');

        renderList(currentList);
        setTimeout(() => { hideLoading(); showPage('resultsPage'); }, 300);
    }

    function sortList(type) {
        if(type === 'distance') {
            if(!userLoc) {
                alert('ê±°ë¦¬ìˆœ ì •ë ¬ì„ ìœ„í•´ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                document.getElementById('locationBanner').classList.remove('hidden');
                showPage('searchPage'); return;
            }
            currentList.forEach(b => {
                if(b.latitude && b.longitude) b.distance = getDist(userLoc.lat, userLoc.lon, b.latitude, b.longitude);
                else b.distance = 99999;
            });
            currentList.sort((a,b) => a.distance - b.distance);
        } else if(type === 'rating') {
            currentList.sort((a,b) => (b.rating||0) - (a.rating||0));
        } else if(type === 'popularity') {
            currentList.sort((a,b) => (b.reviews||0) - (a.reviews||0));
        }
        renderList(currentList);
    }

    function openDetail(biz) {
        currBiz = biz;
        document.getElementById('dtName').innerText = biz.name;
        document.getElementById('dtRating').innerText = `â­ ${biz.rating||0} (${biz.reviews||0} ë¦¬ë·°)`;
        document.getElementById('dtAddr').innerText = biz.address || 'ì •ë³´ ì—†ìŒ';
        document.getElementById('dtPhone').innerText = biz.phone || 'ì •ë³´ ì—†ìŒ';
        document.getElementById('dtHours').innerText = biz.hours || 'ì •ë³´ ì—†ìŒ';
        
        const webRow = document.getElementById('dtWebRow');
        if(biz.website && biz.website.length > 4) {
            let url = biz.website.startsWith('http') ? biz.website : 'https://' + biz.website;
            document.getElementById('dtWeb').innerHTML = `<a href="${url}" target="_blank">í™ˆí˜ì´ì§€ ë°©ë¬¸</a>`;
            webRow.style.display = 'flex';
        } else { webRow.style.display = 'none'; }

        showPage('detailPage');
    }

    // --- 5. Utils ---
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    }
    function goToSearch() { showPage('searchPage'); }
    function goToMain() { showPage('mainPage'); }
    function goToResults() { showPage('resultsPage'); }
    function showLoading() { document.getElementById('loading').classList.add('show'); }
    function hideLoading() { document.getElementById('loading').classList.remove('show'); }

    function makeCall() {
        if(currBiz && currBiz.phone) location.href = `tel:${currBiz.phone.replace(/[^0-9+]/g,'')}`;
        else alert('ì „í™”ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    function openMap() {
        if(!currBiz) return;
        const q = currBiz.googleMapsUrl || currBiz.address || currBiz.name;
        window.open(q.startsWith('http') ? q : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`);
    }

    // --- 6. Location ---
    function checkPermission() {
        if(navigator.permissions) {
            navigator.permissions.query({name:'geolocation'}).then(res => {
                if(res.state === 'prompt') document.getElementById('locationBanner').classList.remove('hidden');
            });
        }
    }
    function requestLocationPermission() {
        if(!navigator.geolocation) return alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        navigator.geolocation.getCurrentPosition(
            pos => {
                userLoc = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                document.getElementById('locationBanner').classList.add('hidden');
                alert('ìœ„ì¹˜ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
            },
            err => alert('ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.')
        );
    }
    function getDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2-lat1) * Math.PI/180;
        const dLon = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
</script>
</body>
</html>
